<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Studio | Home</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
      :root { --indigo:#4F46E5; --muted:#6B7280; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
      .container { max-width: 1080px; margin: 24px auto; padding: 0 16px; }
      .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px 18px; background: linear-gradient(180deg,#ffffff,#f7f8fd); }
      .title { font-weight: 800; font-size: 22px; color: #111827; }
      .tagline { color: var(--muted); margin-top: 6px; }
      .upload { margin-top: 18px; display: flex; gap: 8px; align-items: center; }
      .btn { background: var(--indigo); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-block; }
      .metrics { display:flex; gap:10px; margin-top:14px; }
      .metric { border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; background:#fff; min-width:140px; }
      .metric .label { color:#6B7280; font-size:12px; }
      .metric .value { color:#111827; font-weight:700; font-size:18px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; }
      th { background: #f3f4f6; }
      .section-title { font-weight:700; font-size:16px; margin: 14px 0 8px; }
      pre.debug { background:#0b1020; color:#e6edf3; padding:12px; border-radius:10px; overflow:auto; display:none; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="title">Data Analysis Studio</div>
        <div class="tagline">Upload a CSV or use a sample dataset to get a quick summary.</div>
        <form id="uform" class="upload">
          <input type="file" name="file" accept=".csv" />
          <label>Corr
            <select id="corrMethod" name="corr_method">
              <option value="pearson" selected>Pearson</option>
              <option value="spearman">Spearman</option>
              <option value="kendall">Kendall</option>
            </select>
          </label>
          <label>Filter
            <input type="text" id="filterQuery" name="filter_query" placeholder="e.g. feature_1 > 0 and category == 'A'" style="width:260px;" />
          </label>
          <label>Columns
            <input type="text" id="includeCols" name="include_cols" placeholder="col1,col2" style="width:200px;" />
          </label>
          <label>Limit
            <input type="number" id="limitRows" name="limit_rows" value="" min="0" step="1" style="width:90px;" />
          </label>
          <label>Group By
            <input type="text" id="groupBy" name="group_by" placeholder="e.g. category" style="width:160px;" />
          </label>
          <label>Agg
            <select id="aggFunc" name="agg">
              <option value="">(auto)</option>
              <option value="mean" selected>mean</option>
              <option value="sum">sum</option>
              <option value="count">count</option>
              <option value="median">median</option>
              <option value="min">min</option>
              <option value="max">max</option>
              <option value="nunique">nunique</option>
            </select>
          </label>
          <label>Values
            <input type="text" id="valueCols" name="value_cols" placeholder="numeric1,numeric2" style="width:180px;" />
          </label>
          <label>Pivot Col
            <input type="text" id="pivotCol" name="pivot_col" placeholder="(optional)" style="width:140px;" />
          </label>
          <label>Pivot Fill
            <input type="number" id="pivotFill" name="pivot_fill" placeholder="" style="width:100px;" />
          </label>
          <button class="btn" type="submit">Get Summary</button>
        </form>
        <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
          <a class="btn" href="/api/sample/csv?rows=500&seed=42">Download Sample CSV</a>
          <button id="sampleBtn" class="btn" type="button">Sample Summary</button>
        </div>
      </div>

      <pre id="debug" class="debug"></pre>
      <div id="metrics" class="metrics" style="display:none;"></div>

      <div id="missingSection" style="display:none;">
        <div class="section-title">Missing Summary</div>
        <div style="margin:6px 0;"><button id="missingCsvBtn" class="btn" type="button">Download Missing CSV</button></div>
        <table id="missingTbl"></table>
      </div>

      <div id="corrSection" style="display:none;">
        <div class="section-title">Correlation Heatmap</div>
        <div style="margin:6px 0;"><button id="corrPngBtn" class="btn" type="button">Download Heatmap PNG</button></div>
        <div id="corrChart" style="height:420px;"></div>
      </div>

      <div id="colsSection" style="display:none;">
        <div class="section-title">Columns</div>
        <table id="colsTbl"></table>
      </div>

      <div id="colDetailSection" style="display:none;">
        <div class="section-title">Column Summary</div>
        <div style="font-weight:600; margin:6px 0 4px;">Numeric</div>
        <table id="numColsTbl"></table>
        <div style="font-weight:600; margin:12px 0 4px;">Categorical</div>
        <table id="catColsTbl"></table>
      </div>

      <div id="previewSection" style="display:none;">
        <div class="section-title">Preview</div>
        <div style="margin:6px 0;"><button id="previewCsvBtn" class="btn" type="button">Download Preview CSV</button></div>
        <table id="previewTbl"></table>
      </div>

      <div id="vizSection" style="display:none; margin-top:14px;">
        <div class="section-title">Visualization</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>Chart
            <select id="chartType">
              <option value="histogram">Histogram</option>
              <option value="scatter">Scatter</option>
              <option value="box">Box</option>              <option value="bar_count">Bar Count</option>              <option value="bar_value">Bar (Value)</option>              <option value="line">Line</option>              <option value="density_contour">KDE (Contour)</option>              <option value="density_heatmap">2D Density</option>              <option value="violin">Violin</option>              <option value="scatter_matrix">Scatter Matrix</option>              <option value="feature_importance">Feature Importance</option>
            </select>
          </label>
          <label>X
            <select id="selX"></select>
          </label>
          <label>Y
            <select id="selY"></select>
          </label>
          <label>Color
            <select id="selColor"></select>
          </label>
          <label>Facet Row
            <select id="selFacetRow"></select>
          </label>
          <label>Facet Col
            <select id="selFacetCol"></select>
          </label>
          <label>Bins
            <input type="number" id="bins" value="30" min="5" max="100" step="1" style="width:80px;" />
          </label>
          <label>Normalize
            <select id="norm">
              <option value="">(none)</option>
              <option value="percent">percent</option>
              <option value="probability">probability</option>
            </select>
          </label>
          <label>Barmode
            <select id="barmode">
              <option value="">(auto)</option>
              <option value="group">group</option>
              <option value="stack">stack</option>
              <option value="overlay">overlay</option>
              <option value="relative">relative</option>
            </select>
          </label>
          <label><input type="checkbox" id="logX" /> Log X</label>
          <label><input type="checkbox" id="logY" /> Log Y</label>
          <button id="drawBtn" class="btn" type="button">Draw (Upload)</button>
          <button id="drawSampleBtn" class="btn" type="button">Draw (Sample)</button>
          <button id="vizPngBtn" class="btn" type="button">Download Chart PNG</button>
        </div>
        <div id="vizChart" style="height:460px; margin-top:8px;"></div>
      </div>

      <div id="profileSection" style="display:none; margin-top:14px;">
        <div class="section-title">Profiling Report</div>
        <button id="profileBtn" class="btn" type="button">Generate Profiling (Upload)</button>
        <div id="profileWrap" style="margin-top:8px; height:700px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;">
          <iframe id="profileFrame" srcdoc="" style="width:100%; height:100%; border:0;"></iframe>
        </div>
      </div>

      <div id="modelSection" style="display:none; margin-top:14px;">
        <div class="section-title">Modeling</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>Target
            <select id="modelTarget"></select>
          </label>
          <label>CV
            <input id="cvFolds" type="number" value="5" min="2" max="10" step="1" style="width:80px;" />
          </label>
          <button id="trainBtn" class="btn" type="button">Train (Upload)</button>
          <button id="trainSampleBtn" class="btn" type="button">Train (Sample)</button>
        </div>
        <div id="modelMetrics" style="margin-top:8px;"></div>
        <div style="display:flex; gap:12px; margin-top:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:360px;">
            <div style="font-weight:600; margin-bottom:6px;">Confusion Matrix</div>
            <div id="cmChart" style="height:360px;"></div>
          </div>
          <div style="flex:1; min-width:360px;">
            <div style="font-weight:600; margin-bottom:6px;">Feature Importance</div>
            <div id="fiChart" style="height:360px;"></div>
          </div>
        </div>
      </div>

      <div id="crawlSection" style="margin-top:14px;">
        <div class="section-title">Web Crawl</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="crawlUrl" type="url" placeholder="https://example.com/data.csv" style="width:500px; padding:8px;" />
          <button id="crawlCsvBtn" class="btn" type="button">Fetch CSV from URL</button>
          <button id="crawlTableBtn" class="btn" type="button">Extract HTML Table</button>
        </div>
        <div id="crawlTableWrap" style="display:none; margin-top:8px;">
          <table id="crawlTable"></table>
        </div>
      </div>
    </div>

    <script>
    const form = document.getElementById('uform');
    const dbg = document.getElementById('debug');
    let fileRef = null;
    let currentCols = null;
    let lastSummary = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      fileRef = form.querySelector('input[name="file"]').files[0] || null;
      if(!fileRef){ alert('Upload a CSV first.'); return; }
      dbg.style.display = 'block';
      dbg.innerHTML = 'Generating summary...';
      try {
        const spec = {
          source: { type: 'upload' },
          filters: {
            filter_query: document.getElementById('filterQuery').value || '',
            include_cols: document.getElementById('includeCols').value || '',
            limit_rows: document.getElementById('limitRows').value || ''
          },
          aggregation: {
            group_by: document.getElementById('groupBy').value || '',
            agg: document.getElementById('aggFunc').value || '',
            value_cols: document.getElementById('valueCols').value || '',
            pivot_col: document.getElementById('pivotCol').value || '',
            pivot_fill: document.getElementById('pivotFill').value || ''
          },
          summary: { corr_method: document.getElementById('corrMethod').value, max_corr_dims: 8 }
        };
        const fd = new FormData();
        fd.append('file', fileRef);
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method: 'POST', body: fd });
        const out = await res.json();
        if (!res.ok) throw new Error(out.detail || out.error || 'Request failed');
        const data = out.summary || {};
        dbg.textContent = JSON.stringify(data, null, 2);
        renderSummary(data);
      } catch (err) {
        dbg.textContent = String(err);
      }
    });

    document.getElementById('sampleBtn').addEventListener('click', async () => {
      dbg.style.display = 'block';
      dbg.innerHTML = 'Generating sample summary...';
      try {
        const spec = {
          source: { type: 'sample', rows: 500, seed: 42 },
          filters: {
            filter_query: document.getElementById('filterQuery').value || '',
            include_cols: document.getElementById('includeCols').value || '',
            limit_rows: document.getElementById('limitRows').value || ''
          },
          aggregation: {
            group_by: document.getElementById('groupBy').value || '',
            agg: document.getElementById('aggFunc').value || '',
            value_cols: document.getElementById('valueCols').value || '',
            pivot_col: document.getElementById('pivotCol').value || '',
            pivot_fill: document.getElementById('pivotFill').value || ''
          },
          summary: { corr_method: document.getElementById('corrMethod').value, max_corr_dims: 8 }
        };
        const fd = new FormData();
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method: 'POST', body: fd });
        const out = await res.json();
        if (!res.ok) throw new Error(out.detail || out.error || 'Request failed');
        const data = out.summary || {};
        dbg.textContent = JSON.stringify(data, null, 2);
        renderSummary(data);
      } catch (err) {
        dbg.textContent = String(err);
      }
    });

    function renderSummary(data){
      // Cache latest summary for downloads
      lastSummary = data;
      // Metrics
      const metrics = document.getElementById('metrics');
      metrics.style.display = 'flex';
      metrics.innerHTML = ''+
        metricCard('Rows', formatValue(data.rows))+
        metricCard('Columns', formatValue(data.columns))+
        metricCard('Memory', data.memory ?? '');

      // Missing table
      const ms = Array.isArray(data.missing) ? data.missing : [];
      const msWrap = document.getElementById('missingSection');
      const tbl = document.getElementById('missingTbl');
      if(ms.length){
        msWrap.style.display = 'block';
        tbl.innerHTML = '<tr><th>Column</th><th>Missing</th><th>Pct</th></tr>' +
          ms.map(r => `<tr><td>${escapeHtml(r.column)}</td><td>${formatValue(r.missing_count)}</td><td>${(Number(r.missing_pct)*100).toFixed(2)}%</td></tr>`).join('');
      } else {
        msWrap.style.display = 'none';
        tbl.innerHTML = '';
      }

      // Correlation heatmap
      const corr = data.corr;
      const corrWrap = document.getElementById('corrSection');
      if(corr && corr.labels && corr.matrix){
        corrWrap.style.display = 'block';
        const trace = { z: corr.matrix, x: corr.labels, y: corr.labels, type: 'heatmap', colorscale: 'RdBu', reversescale: true };
        const layout = { margin: {l: 60, r: 10, b: 60, t: 10}, xaxis: { automargin: true }, yaxis: { automargin: true } };
        Plotly.newPlot('corrChart', [trace], layout, {displaylogo:false, responsive:true});
      } else {
        corrWrap.style.display = 'none';
      }

      // Columns info
      const ci = data.columns_info || {};
      currentCols = ci;
      const ctbl = document.getElementById('colsTbl');
      const csec = document.getElementById('colsSection');
      const fmtList = (arr) => (Array.isArray(arr) ? arr.map(escapeHtml).join(', ') : '');
      csec.style.display = 'block';
      ctbl.innerHTML = '<tr><th>Numeric</th><th>Categorical</th><th>Datetime</th></tr>' +
        `<tr><td>${fmtList(ci.numeric)}</td><td>${fmtList(ci.categorical)}</td><td>${fmtList(ci.datetime)}</td></tr>`;

      // Viz controls
      setupVizControls(ci);

      // Column stats tables
      const stats = data.columns_stats || {};
      const numStats = Array.isArray(stats.numeric) ? stats.numeric : [];
      const catStats = Array.isArray(stats.categorical) ? stats.categorical : [];
      const dsec = document.getElementById('colDetailSection');
      const nt = document.getElementById('numColsTbl');
      const ct = document.getElementById('catColsTbl');
      if(numStats.length || catStats.length){
        dsec.style.display = 'block';
        if(numStats.length){
          nt.innerHTML = '<tr><th>Column</th><th>Count</th><th>Unique</th><th>Missing</th><th>Mean</th><th>Std</th><th>Min</th><th>25%</th><th>Median</th><th>75%</th><th>Max</th></tr>' +
            numStats.map(r => `<tr><td>${escapeHtml(r.column)}</td><td>${formatValue(r.count)}</td><td>${formatValue(r.unique)}</td><td>${formatValue(r.missing)}</td><td>${formatValue(r.mean)}</td><td>${formatValue(r.std)}</td><td>${formatValue(r.min)}</td><td>${formatValue(r.p25)}</td><td>${formatValue(r.median)}</td><td>${formatValue(r.p75)}</td><td>${formatValue(r.max)}</td></tr>`).join('');
        } else { nt.innerHTML = '<tr><td>(none)</td></tr>'; }
        if(catStats.length){
          const fmtTop = (arr) => (Array.isArray(arr) ? arr.map(o=>`${escapeHtml(o.value)} (${formatValue(o.count)}, ${(Number(o.pct)*100).toFixed(2)}%)`).join(', ') : '');
          ct.innerHTML = '<tr><th>Column</th><th>Unique</th><th>Missing</th><th>Top</th></tr>' +
            catStats.map(r => `<tr><td>${escapeHtml(r.column)}</td><td>${formatValue(r.unique)}</td><td>${formatValue(r.missing)}</td><td>${fmtTop(r.top)}</td></tr>`).join('');
        } else { ct.innerHTML = '<tr><td>(none)</td></tr>'; }
      } else {
        dsec.style.display = 'none';
        nt.innerHTML = ''; ct.innerHTML = '';
      }

      // Preview table (post-filter/aggregation)
      const pv = Array.isArray(data.preview) ? data.preview : [];
      const psec = document.getElementById('previewSection');
      const ptbl = document.getElementById('previewTbl');
      if(pv.length){
        psec.style.display = 'block';
        const cols = Object.keys(pv[0] || {});
        const thead = '<tr>' + cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('') + '</tr>';
        const tbody = pv.map(r=>'<tr>' + cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('') + '</tr>').join('');
        ptbl.innerHTML = thead + tbody;
        const btn = document.getElementById('previewCsvBtn');
        if(btn){
          btn.onclick = () => {
            if(!pv.length){ alert('No preview data.'); return; }
            try {
              const csv = toCsvFromObjects(pv);
              const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'preview.csv';
              document.body.appendChild(a); a.click(); a.remove();
              setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
            } catch(err){ alert('Failed to export CSV: '+ String(err)); }
          };
        }
      } else {
        psec.style.display = 'none';
        ptbl.innerHTML = '';
      }
    }

    function metricCard(label, value){
      return `<div class="metric"><div class="label">${label}</div><div class="value">${value}</div></div>`
    }
    function formatValue(v){
      const n = Number(v);
      return Number.isFinite(n) ? n.toLocaleString() : String(v ?? '');
    }
    function toCsvFromObjects(rows){
      if(!Array.isArray(rows) || rows.length === 0) return '';
      const cols = Object.keys(rows[0] || {});
      const esc = (v) => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
      };
      const lines = [];
      lines.push(cols.map(esc).join(','));
      for(const r of rows){ lines.push(cols.map(c => esc(r[c])).join(',')); }
      return lines.join('\n');
    }
    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

      function setupVizControls(ci){
        const vsec = document.getElementById('vizSection');
        vsec.style.display = 'block';
      const selX = document.getElementById('selX');
      const selY = document.getElementById('selY');
      const selColor = document.getElementById('selColor');
      const selFacetRow = document.getElementById('selFacetRow');
      const selFacetCol = document.getElementById('selFacetCol');
      const fill = (el, items, includeNone=false) => {
        el.innerHTML = '';
        if(includeNone){ const o=document.createElement('option'); o.value=''; o.textContent='(none)'; el.appendChild(o); }
        (items||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
      };
      fill(selX, (ci.datetime||[]).concat(ci.numeric||[]).concat(ci.categorical||[]));
      fill(selY, ci.numeric||[], true);
      fill(selColor, (ci.categorical||[]), true);
      fill(selFacetRow, (ci.categorical||[]), true);
      fill(selFacetCol, (ci.categorical||[]), true);

      document.getElementById('drawBtn').onclick = async () => {
        if(!fileRef){ alert('Upload a CSV first.'); return; }
        const spec = {
          source: { type: 'upload' },
          filters: {
            filter_query: document.getElementById('filterQuery').value || '',
            include_cols: document.getElementById('includeCols').value || '',
            limit_rows: document.getElementById('limitRows').value || ''
          },
          aggregation: {
            group_by: document.getElementById('groupBy').value || '',
            agg: document.getElementById('aggFunc').value || '',
            value_cols: document.getElementById('valueCols').value || '',
            pivot_col: document.getElementById('pivotCol').value || '',
            pivot_fill: document.getElementById('pivotFill').value || ''
          },
          visualize: {
            chart: document.getElementById('chartType').value,
            x: selX.value || '', y: selY.value || '', color: selColor.value || '', bins: Number(document.getElementById('bins').value),
            facet_row: selFacetRow.value || '', facet_col: selFacetCol.value || '', norm: document.getElementById('norm').value || '', barmode: document.getElementById('barmode').value || '',
            log_x: document.getElementById('logX').checked, log_y: document.getElementById('logY').checked
          }
        };
        const fd = new FormData();
        fd.append('file', fileRef);
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method:'POST', body: fd });
        const data = await res.json();
        if(!res.ok){ alert(data.detail || data.error || 'Failed'); return; }
        const fig = (data.visualize && data.visualize.figure) ? data.visualize.figure : {};
        Plotly.newPlot('vizChart', fig.data || [], fig.layout || {}, {displaylogo:false, responsive:true});
      };

      document.getElementById('drawSampleBtn').onclick = async () => {
        const spec = {
          source: { type: 'sample', rows: 500, seed: 42 },
          filters: {
            filter_query: document.getElementById('filterQuery').value || '',
            include_cols: document.getElementById('includeCols').value || '',
            limit_rows: document.getElementById('limitRows').value || ''
          },
          aggregation: {
            group_by: document.getElementById('groupBy').value || '',
            agg: document.getElementById('aggFunc').value || '',
            value_cols: document.getElementById('valueCols').value || '',
            pivot_col: document.getElementById('pivotCol').value || '',
            pivot_fill: document.getElementById('pivotFill').value || ''
          },
          visualize: {
            chart: document.getElementById('chartType').value,
            x: selX.value || '', y: selY.value || '', color: selColor.value || '', bins: Number(document.getElementById('bins').value),
            facet_row: selFacetRow.value || '', facet_col: selFacetCol.value || '', norm: document.getElementById('norm').value || '', barmode: document.getElementById('barmode').value || '',
            log_x: document.getElementById('logX').checked, log_y: document.getElementById('logY').checked
          }
        };
        const fd = new FormData();
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method:'POST', body: fd });
        const data = await res.json();
        if(!res.ok){ alert(data.detail || data.error || 'Failed'); return; }
        const fig = (data.visualize && data.visualize.figure) ? data.visualize.figure : {};
        Plotly.newPlot('vizChart', fig.data || [], fig.layout || {}, {displaylogo:false, responsive:true});
      };

      // Modeling controls
      const msec = document.getElementById('modelSection');
      msec.style.display = 'block';
      const modelTarget = document.getElementById('modelTarget');
      const fillTargets = (cols) => {
        modelTarget.innerHTML = '';
        const all = (cols.datetime||[]).concat(cols.numeric||[]).concat(cols.categorical||[]);
        all.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; modelTarget.appendChild(o); });
        if(all.includes('target')) modelTarget.value='target';
      };
      fillTargets(ci);
      document.getElementById('trainBtn').onclick = async () => {
        if(!fileRef){ alert('Upload a CSV first.'); return; }
        const spec = { source: { type:'upload' }, model: { target: modelTarget.value || '', cv: Number(document.getElementById('cvFolds').value || '5') } };
        const fd = new FormData();
        fd.append('file', fileRef);
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method:'POST', body: fd });
        const out = await res.json();
        if(!res.ok){ alert(out.detail || out.error || 'Failed'); return; }
        renderModeling(out.model || {});
      };
      document.getElementById('trainSampleBtn').onclick = async () => {
        const spec = { source: { type:'sample', rows: 500, seed: 42 }, model: { target: modelTarget.value || '', cv: Number(document.getElementById('cvFolds').value || '5') } };
        const fd = new FormData();
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method:'POST', body: fd });
        const out = await res.json();
        if(!res.ok){ alert(out.detail || out.error || 'Failed'); return; }
        renderModeling(out.model || {});
      };

      function renderModeling(m){
        const wrap = document.getElementById('modelMetrics');
        const task = m.task || '';
        const toRow = (k,v) => `<tr><td style="color:#6B7280;">${escapeHtml(k)}</td><td>${formatValue(v)}</td></tr>`;
        const met = m.metrics || {};
        let html = `<div class="metric"><div class="label">Task</div><div class="value">${escapeHtml(task)}</div></div>`;
        html += '<table style="margin-top:6px;">' + Object.keys(met).map(k=>toRow(k, met[k])).join('') + '</table>';
        wrap.innerHTML = html;
        // Confusion Matrix
        const cmEl = document.getElementById('cmChart');
        if(task==='classification' && Array.isArray(m.confusion_matrix) && Array.isArray(m.labels)){
          const trace = { z: m.confusion_matrix, x: m.labels, y: m.labels, type:'heatmap', colorscale:'Blues' };
          const layout = { margin:{l:60,r:10,b:60,t:10}, xaxis:{automargin:true}, yaxis:{automargin:true} };
          Plotly.newPlot(cmEl, [trace], layout, {displaylogo:false, responsive:true});
        } else {
          Plotly.purge(cmEl);
        }
        // Feature Importance
        const fiEl = document.getElementById('fiChart');
        const fis = Array.isArray(m.feature_importance) ? m.feature_importance : [];
        if(fis.length){
          const y = fis.map(r=>r.feature);
          const x = fis.map(r=>r.importance);
          const trace = { x, y, type:'bar', orientation:'h' };
          const layout = { margin:{l:120,r:10,b:40,t:10} };
          Plotly.newPlot(fiEl, [trace], layout, {displaylogo:false, responsive:true});
        } else {
          Plotly.purge(fiEl);
        }
      }

      // Download handlers (client-side)
      const missingBtn = document.getElementById('missingCsvBtn');
      if(missingBtn){
        missingBtn.onclick = () => {
          try {
            const ms = (lastSummary && Array.isArray(lastSummary.missing)) ? lastSummary.missing : [];
            if(!ms.length){ alert('No missing summary available.'); return; }
            const headers = ['column','missing_count','missing_pct'];
            const rows = ms.map(r => [r.column, r.missing_count, r.missing_pct]);
            const csv = [headers.join(','), ...rows.map(r => r.map(v => String(v).includes(',') ? '"'+String(v).replaceAll('"','""')+'"' : String(v)).join(','))].join('\n');
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'missing_summary.csv';
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
          } catch(err){ alert('Failed to generate CSV: '+ String(err)); }
        };
      }

      const corrBtn = document.getElementById('corrPngBtn');
      if(corrBtn){
        corrBtn.onclick = async () => {
          const chartEl = document.getElementById('corrChart');
          if(!chartEl || !chartEl.data || !chartEl.data.length){ alert('No heatmap to download.'); return; }
          try {
            const dataUrl = await Plotly.toImage(chartEl, {format:'png', height:600, width:800, scale:2});
            const a = document.createElement('a'); a.href = dataUrl; a.download = 'correlation_heatmap.png';
            document.body.appendChild(a); a.click(); a.remove();
          } catch(err){ alert('Failed to export PNG: '+ String(err)); }
        };
      }

      const vizBtn = document.getElementById('vizPngBtn');
      if(vizBtn){
        vizBtn.onclick = async () => {
          const chartEl = document.getElementById('vizChart');
          if(!chartEl || !chartEl.data || !chartEl.data.length){ alert('No chart to download.'); return; }
          try {
            const dataUrl = await Plotly.toImage(chartEl, {format:'png', height:640, width:960, scale:2});
            const a = document.createElement('a'); a.href = dataUrl; a.download = 'chart.png';
            document.body.appendChild(a); a.click(); a.remove();
          } catch(err){ alert('Failed to export PNG: '+ String(err)); }
        };
      }

      // Profiling
      document.getElementById('profileSection').style.display = 'block';
      document.getElementById('profileBtn').onclick = async () => {
        if(!fileRef){ alert('Upload a CSV first.'); return; }
        const spec = { source: { type:'upload' }, profile: { minimal: true, sample_n: 2000 } };
        const fd = new FormData();
        fd.append('file', fileRef);
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method:'POST', body: fd });
        const data = await res.json();
        if(!res.ok){ alert(data.detail || 'Failed'); return; }
        document.getElementById('profileFrame').setAttribute('srcdoc', data.profile_html || '<p>No content</p>');
      };

      // Crawl handlers
      document.getElementById('crawlCsvBtn').onclick = async () => {
        const url = document.getElementById('crawlUrl').value.trim();
        if(!url){ alert('Enter URL'); return; }
        dbg.style.display='block'; dbg.textContent='Fetching CSV...';
        const cm = document.getElementById('corrMethod').value;
        const spec = {
          source: { type:'url', url },
          summary: { corr_method: cm, max_corr_dims: 8 }
        };
        const fd = new FormData();
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method:'POST', body: fd });
        const out = await res.json();
        if(!res.ok){ alert(out.detail || 'Failed'); return; }
        const data = out.summary || {};
        dbg.textContent = JSON.stringify(data, null, 2);
        renderSummary(data);
      };
      document.getElementById('crawlTableBtn').onclick = async () => {
        const url = document.getElementById('crawlUrl').value.trim();
        if(!url){ alert('Enter URL'); return; }
        dbg.style.display='block'; dbg.textContent='Fetching table...';
        const spec = { crawl: { table: { url, index: 0, max_rows: 50 } } };
        const fd = new FormData();
        fd.append('spec', JSON.stringify(spec));
        const res = await fetch('/api/run', { method:'POST', body: fd });
        const out = await res.json();
        if(!res.ok){ alert(out.detail || 'Failed'); return; }
        const data = out.crawl_table || {};
        dbg.textContent = JSON.stringify(data, null, 2);
        const wrap = document.getElementById('crawlTableWrap');
        const tbl = document.getElementById('crawlTable');
        wrap.style.display = 'block';
        const rows = data.preview || [];
        if(rows.length){
          const cols = Object.keys(rows[0]);
          tbl.innerHTML = '<tr>'+cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')+'</tr>' + rows.map(r=>'<tr>'+cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('')+'</tr>').join('');
        } else {
          tbl.innerHTML = '<tr><td>(empty)</td></tr>';
        }
      };
    }
    </script>
  </body>
  </html>







