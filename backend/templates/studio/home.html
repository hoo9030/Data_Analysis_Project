<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Studio | Home</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
      :root { --indigo:#4F46E5; --muted:#6B7280; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
      .container { max-width: 1080px; margin: 24px auto; padding: 0 16px; }
      .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px 18px; background: linear-gradient(180deg,#ffffff,#f7f8fd); }
      .title { font-weight: 800; font-size: 22px; color: #111827; }
      .tagline { color: var(--muted); margin-top: 6px; }
      .upload { margin-top: 18px; display: flex; gap: 8px; align-items: center; }
      .btn { background: var(--indigo); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-block; }
      .metrics { display:flex; gap:10px; margin-top:14px; }
      .metric { border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; background:#fff; min-width:140px; }
      .metric .label { color:#6B7280; font-size:12px; }
      .metric .value { color:#111827; font-weight:700; font-size:18px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; }
      th { background: #f3f4f6; }
      .section-title { font-weight:700; font-size:16px; margin: 14px 0 8px; }
      pre.debug { background:#0b1020; color:#e6edf3; padding:12px; border-radius:10px; overflow:auto; display:none; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="title">Data Analysis Studio</div>
        <div class="tagline">Upload a CSV or use a sample dataset to get a quick summary.</div>
        <form id="uform" class="upload">
          <input type="file" name="file" accept=".csv" />
          <button class="btn" type="submit">Get Summary</button>
        </form>
        <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
          <a class="btn" href="/api/sample/csv?rows=500&seed=42">Download Sample CSV</a>
          <button id="sampleBtn" class="btn" type="button">Sample Summary</button>
        </div>
      </div>

      <pre id="debug" class="debug"></pre>
      <div id="metrics" class="metrics" style="display:none;"></div>

      <div id="missingSection" style="display:none;">
        <div class="section-title">Missing Summary</div>
        <div style="margin:6px 0;"><button id="missingCsvBtn" class="btn" type="button">Download Missing CSV</button></div>
        <table id="missingTbl"></table>
      </div>

      <div id="corrSection" style="display:none;">
        <div class="section-title">Correlation Heatmap</div>
        <div style="margin:6px 0;"><button id="corrPngBtn" class="btn" type="button">Download Heatmap PNG</button></div>
        <div id="corrChart" style="height:420px;"></div>
      </div>

      <div id="colsSection" style="display:none;">
        <div class="section-title">Columns</div>
        <table id="colsTbl"></table>
      </div>

      <div id="vizSection" style="display:none; margin-top:14px;">
        <div class="section-title">Visualization</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>Chart
            <select id="chartType">
              <option value="histogram">Histogram</option>
              <option value="scatter">Scatter</option>
              <option value="box">Box</option>              <option value="bar_count">Bar Count</option>              <option value="line">Line</option>              <option value="density_contour">KDE (Contour)</option>              <option value="density_heatmap">2D Density</option>
            </select>
          </label>
          <label>X
            <select id="selX"></select>
          </label>
          <label>Y
            <select id="selY"></select>
          </label>
          <label>Color
            <select id="selColor"></select>
          </label>
          <label>Facet Row
            <select id="selFacetRow"></select>
          </label>
          <label>Facet Col
            <select id="selFacetCol"></select>
          </label>
          <label>Bins
            <input type="number" id="bins" value="30" min="5" max="100" step="1" style="width:80px;" />
          </label>
          <label>Normalize
            <select id="norm">
              <option value="">(none)</option>
              <option value="percent">percent</option>
              <option value="probability">probability</option>
            </select>
          </label>
          <label>Barmode
            <select id="barmode">
              <option value="">(auto)</option>
              <option value="group">group</option>
              <option value="stack">stack</option>
              <option value="overlay">overlay</option>
              <option value="relative">relative</option>
            </select>
          </label>
          <label><input type="checkbox" id="logX" /> Log X</label>
          <label><input type="checkbox" id="logY" /> Log Y</label>
          <button id="drawBtn" class="btn" type="button">Draw (Upload)</button>
          <button id="drawSampleBtn" class="btn" type="button">Draw (Sample)</button>
          <button id="vizPngBtn" class="btn" type="button">Download Chart PNG</button>
        </div>
        <div id="vizChart" style="height:460px; margin-top:8px;"></div>
      </div>

      <div id="profileSection" style="display:none; margin-top:14px;">
        <div class="section-title">Profiling Report</div>
        <button id="profileBtn" class="btn" type="button">Generate Profiling (Upload)</button>
        <div id="profileWrap" style="margin-top:8px; height:700px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;">
          <iframe id="profileFrame" srcdoc="" style="width:100%; height:100%; border:0;"></iframe>
        </div>
      </div>

      <div id="crawlSection" style="margin-top:14px;">
        <div class="section-title">Web Crawl</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="crawlUrl" type="url" placeholder="https://example.com/data.csv" style="width:500px; padding:8px;" />
          <button id="crawlCsvBtn" class="btn" type="button">Fetch CSV from URL</button>
          <button id="crawlTableBtn" class="btn" type="button">Extract HTML Table</button>
        </div>
        <div id="crawlTableWrap" style="display:none; margin-top:8px;">
          <table id="crawlTable"></table>
        </div>
      </div>
    </div>

    <script>
    const form = document.getElementById('uform');
    const dbg = document.getElementById('debug');
    let fileRef = null;
    let currentCols = null;
    let lastSummary = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      fileRef = form.querySelector('input[name="file"]').files[0] || null;
      dbg.style.display = 'block';
      dbg.innerHTML = 'Generating summary...';
      try {
        const res = await fetch('/api/eda/summary', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');
        dbg.textContent = JSON.stringify(data, null, 2);
        renderSummary(data);
      } catch (err) {
        dbg.textContent = String(err);
      }
    });

    document.getElementById('sampleBtn').addEventListener('click', async () => {
      dbg.style.display = 'block';
      dbg.innerHTML = 'Generating sample summary...';
      try {
        const res = await fetch('/api/sample/summary');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');
        dbg.textContent = JSON.stringify(data, null, 2);
        renderSummary(data);
      } catch (err) {
        dbg.textContent = String(err);
      }
    });

    function renderSummary(data){
      // Metrics
      const metrics = document.getElementById('metrics');
      metrics.style.display = 'flex';
      metrics.innerHTML = ''+
        metricCard('Rows', formatValue(data.rows))+
        metricCard('Columns', formatValue(data.columns))+
        metricCard('Memory', data.memory ?? '');

      // Missing table
      const ms = Array.isArray(data.missing) ? data.missing : [];
      const msWrap = document.getElementById('missingSection');
      const tbl = document.getElementById('missingTbl');
      if(ms.length){
        msWrap.style.display = 'block';
        tbl.innerHTML = '<tr><th>Column</th><th>Missing</th><th>Pct</th></tr>' +
          ms.map(r => `<tr><td>${escapeHtml(r.column)}</td><td>${formatValue(r.missing_count)}</td><td>${(Number(r.missing_pct)*100).toFixed(2)}%</td></tr>`).join('');
      } else {
        msWrap.style.display = 'none';
        tbl.innerHTML = '';
      }

      // Correlation heatmap
      const corr = data.corr;
      const corrWrap = document.getElementById('corrSection');
      if(corr && corr.labels && corr.matrix){
        corrWrap.style.display = 'block';
        const trace = { z: corr.matrix, x: corr.labels, y: corr.labels, type: 'heatmap', colorscale: 'RdBu', reversescale: true };
        const layout = { margin: {l: 60, r: 10, b: 60, t: 10}, xaxis: { automargin: true }, yaxis: { automargin: true } };
        Plotly.newPlot('corrChart', [trace], layout, {displaylogo:false, responsive:true});
      } else {
        corrWrap.style.display = 'none';
      }

      // Columns info
      const ci = data.columns_info || {};
      currentCols = ci;
      const ctbl = document.getElementById('colsTbl');
      const csec = document.getElementById('colsSection');
      const fmtList = (arr) => (Array.isArray(arr) ? arr.map(escapeHtml).join(', ') : '');
      csec.style.display = 'block';
      ctbl.innerHTML = '<tr><th>Numeric</th><th>Categorical</th><th>Datetime</th></tr>' +
        `<tr><td>${fmtList(ci.numeric)}</td><td>${fmtList(ci.categorical)}</td><td>${fmtList(ci.datetime)}</td></tr>`;

      // Viz controls
      setupVizControls(ci);
    }

    function metricCard(label, value){
      return `<div class="metric"><div class="label">${label}</div><div class="value">${value}</div></div>`
    }
    function formatValue(v){
      const n = Number(v);
      return Number.isFinite(n) ? n.toLocaleString() : String(v ?? '');
    }
    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function setupVizControls(ci){
      const vsec = document.getElementById('vizSection');
      vsec.style.display = 'block';
      const selX = document.getElementById('selX');
      const selY = document.getElementById('selY');
      const selColor = document.getElementById('selColor');
      const selFacetRow = document.getElementById('selFacetRow');
      const selFacetCol = document.getElementById('selFacetCol');
      const fill = (el, items, includeNone=false) => {
        el.innerHTML = '';
        if(includeNone){ const o=document.createElement('option'); o.value=''; o.textContent='(none)'; el.appendChild(o); }
        (items||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
      };
      fill(selX, (ci.datetime||[]).concat(ci.numeric||[]).concat(ci.categorical||[]));
      fill(selY, ci.numeric||[], true);
      fill(selColor, (ci.categorical||[]), true);
      fill(selFacetRow, (ci.categorical||[]), true);
      fill(selFacetCol, (ci.categorical||[]), true);

      document.getElementById('drawBtn').onclick = async () => {
        if(!fileRef){ alert('Upload a CSV first.'); return; }
        const fd = new FormData();
        fd.append('file', fileRef);
        fd.append('chart', document.getElementById('chartType').value);
        fd.append('x', selX.value || '');
        fd.append('y', selY.value || '');
        fd.append('color', selColor.value || '');
        fd.append('bins', document.getElementById('bins').value);
        fd.append('facet_row', selFacetRow.value || '');
        fd.append('facet_col', selFacetCol.value || '');
        fd.append('norm', document.getElementById('norm').value || '');
        fd.append('barmode', document.getElementById('barmode').value || '');
        fd.append('log_x', document.getElementById('logX').checked ? '1' : '0');
        fd.append('log_y', document.getElementById('logY').checked ? '1' : '0');
        const res = await fetch('/api/eda/visualize', { method:'POST', body: fd });
        const data = await res.json();
        if(!res.ok){ alert(data.detail || data.error || 'Failed'); return; }
        Plotly.newPlot('vizChart', (data.figure && data.figure.data) ? data.figure.data : [], (data.figure && data.figure.layout) ? data.figure.layout : {}, {displaylogo:false, responsive:true});
      };

      document.getElementById('drawSampleBtn').onclick = async () => {
        const params = new URLSearchParams({
          chart: document.getElementById('chartType').value,
          x: selX.value || '', y: selY.value || '', color: selColor.value || '', bins: String(document.getElementById('bins').value)
        });
        params.set('facet_row', selFacetRow.value || '');
        params.set('facet_col', selFacetCol.value || '');
        params.set('norm', document.getElementById('norm').value || '');
        params.set('barmode', document.getElementById('barmode').value || '');
        params.set('log_x', document.getElementById('logX').checked ? '1' : '0');
        params.set('log_y', document.getElementById('logY').checked ? '1' : '0');
        const res = await fetch('/api/sample/visualize?' + params.toString());
        const data = await res.json();
        if(!res.ok){ alert(data.detail || data.error || 'Failed'); return; }
        Plotly.newPlot('vizChart', (data.figure && data.figure.data) ? data.figure.data : [], (data.figure && data.figure.layout) ? data.figure.layout : {}, {displaylogo:false, responsive:true});
      };

      // Profiling
      document.getElementById('profileSection').style.display = 'block';
      document.getElementById('profileBtn').onclick = async () => {
        if(!fileRef){ alert('Upload a CSV first.'); return; }
        const fd = new FormData();
        fd.append('file', fileRef);
        fd.append('minimal', '1');
        fd.append('sample_n', '2000');
        const res = await fetch('/api/profile/html', { method:'POST', body: fd });
        const html = await res.text();
        if(!res.ok){ alert(html); return; }
        document.getElementById('profileFrame').setAttribute('srcdoc', html);
      };

      // Crawl handlers
      document.getElementById('crawlCsvBtn').onclick = async () => {
        const url = document.getElementById('crawlUrl').value.trim();
        if(!url){ alert('Enter URL'); return; }
        dbg.style.display='block'; dbg.textContent='Fetching CSV...';
        const res = await fetch('/api/crawl/csv?'+ new URLSearchParams({url}));
        const data = await res.json();
        if(!res.ok){ alert(data.detail || 'Failed'); return; }
        dbg.textContent = JSON.stringify(data, null, 2);
        renderSummary(data);
      };
      document.getElementById('crawlTableBtn').onclick = async () => {
        const url = document.getElementById('crawlUrl').value.trim();
        if(!url){ alert('Enter URL'); return; }
        dbg.style.display='block'; dbg.textContent='Fetching table...';
        const res = await fetch('/api/crawl/table?'+ new URLSearchParams({url}));
        const data = await res.json();
        if(!res.ok){ alert(data.detail || 'Failed'); return; }
        dbg.textContent = JSON.stringify(data, null, 2);
        const wrap = document.getElementById('crawlTableWrap');
        const tbl = document.getElementById('crawlTable');
        wrap.style.display = 'block';
        const rows = data.preview || [];
        if(rows.length){
          const cols = Object.keys(rows[0]);
          tbl.innerHTML = '<tr>'+cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')+'</tr>' + rows.map(r=>'<tr>'+cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('')+'</tr>').join('');
        } else {
          tbl.innerHTML = '<tr><td>(empty)</td></tr>';
        }
      };
    }
    </script>
  </body>
  </html>







